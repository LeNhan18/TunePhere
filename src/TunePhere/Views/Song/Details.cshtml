@model TunePhere.Models.Song
@{
    ViewData["Title"] = Model.Title;
}

<div class="container mt-4">
    <div class="row">
        <!-- Phần trái: Ảnh bìa và thông tin bài hát -->
        <div class="col-md-4">
            <div class="card mb-4 shadow-sm">
                <img src="@Model.ImageUrl" class="card-img-top img-fluid" alt="@Model.Title">
                <div class="card-body">
                    <h2 class="card-title">@Model.Title</h2>
                    <p class="card-text">
                        <span class="text-muted">Nghệ sĩ: </span>@Model.Artist<br />
                        <span class="text-muted">Thể loại: </span>@Model.Genre<br />
                        <span class="text-muted">Thời lượng: </span>@Model.Duration.ToString("hh\\:mm\\:ss")<br />
                        <span class="text-muted">Ngày tải lên: </span>@Model.UploadDate.ToString("dd/MM/yyyy")<br />
                    </p>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addToPlaylistModal">
                                <i class="bi bi-plus-circle me-1"></i>Thêm vào Playlist
                            </button>
                            <a asp-controller="Remix" asp-action="Index" asp-route-id="@Model.SongId" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-music-note-beamed me-1"></i>Remix bài này
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phần phải: Trình phát nhạc và lyrics -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3>Trình phát nhạc</h3>
                    <div class="audio-player mb-4">
                        <audio id="audioPlayer" class="w-100" controls>
                            <source src="@Model.FileUrl" type="audio/mpeg">
                            Trình duyệt của bạn không hỗ trợ phát âm thanh.
                        </audio>
                        <div class="progress mt-2" style="height: 5px;">
                            <div id="audioProgress" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small id="currentTime">0:00</small>
                            <small id="duration">0:00</small>
                        </div>
                    </div>

                    <h3>Lyrics</h3>
                    <div class="lyrics-container p-3 bg-light rounded" style="height: 300px; overflow-y: auto;">
                        @if (ViewBag.Lyrics != null)
                        {
                            <div id="lyrics-sync">
                                @foreach (var line in ViewBag.Lyrics.LyricText.Split('\n'))
                                {
                                    <p class="lyrics-line">@line</p>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">Không có lời bài hát.</p>
                        }
                    </div>
                </div>
            </div>

            <!-- Phần bình luận -->
            <div class="card mt-4 shadow-sm">
                <div class="card-body">
                    <h3>Bình luận</h3>
                    <div class="comments-container">
                        <form>
                            <div class="mb-3">
                                <textarea class="form-control" rows="2" placeholder="Viết bình luận của bạn..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Gửi</button>
                        </form>
                        <div class="mt-4">
                            <p class="text-muted">Chưa có bình luận nào.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Thêm vào Playlist -->
<div class="modal fade" id="addToPlaylistModal" tabindex="-1" aria-labelledby="addToPlaylistModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addToPlaylistModalLabel">Thêm vào Playlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    <!-- Danh sách playlist sẽ được thêm vào đây bằng JavaScript -->
                    <a href="#" class="list-group-item list-group-item-action">Chưa có playlist nào.</a>
                </div>
                <div class="mt-3">
                    <button class="btn btn-outline-primary w-100">
                        <i class="bi bi-plus-circle me-1"></i>Tạo playlist mới
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // JavaScript để xử lý trình phát nhạc và lyrics đồng bộ
        document.addEventListener('DOMContentLoaded', function () {
            const audioPlayer = document.getElementById('audioPlayer');
            const audioProgress = document.getElementById('audioProgress');
            const currentTimeDisplay = document.getElementById('currentTime');
            const durationDisplay = document.getElementById('duration');
            const lyricsContainer = document.getElementById('lyrics-sync');

            // Cập nhật thanh tiến trình
            audioPlayer.addEventListener('timeupdate', function () {
                const percentage = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                audioProgress.style.width = percentage + '%';
                
                // Cập nhật hiển thị thời gian
                currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);
                
                // Cuộn lyrics theo thời gian (giả lập - trong thực tế cần dữ liệu thời gian cho từng dòng)
                if (lyricsContainer) {
                    const lyricsLines = lyricsContainer.querySelectorAll('.lyrics-line');
                    const lineIndex = Math.floor((audioPlayer.currentTime / audioPlayer.duration) * lyricsLines.length);
                    
                    // Highlight dòng hiện tại
                    lyricsLines.forEach(line => line.classList.remove('active'));
                    if (lyricsLines[lineIndex]) {
                        lyricsLines[lineIndex].classList.add('active');
                        lyricsLines[lineIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });

            // Hiển thị tổng thời gian khi metadata được tải
            audioPlayer.addEventListener('loadedmetadata', function () {
                durationDisplay.textContent = formatTime(audioPlayer.duration);
            });

            // Định dạng thời gian từ giây sang mm:ss
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return minutes + ':' + (remainingSeconds < 10 ? '0' : '') + remainingSeconds;
            }

            // Cho phép click vào thanh tiến trình để nhảy đến vị trí tương ứng
            document.querySelector('.progress').addEventListener('click', function (e) {
                const percent = e.offsetX / this.offsetWidth;
                audioPlayer.currentTime = percent * audioPlayer.duration;
            });
        });
    </script>
} 